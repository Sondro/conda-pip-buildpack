#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env_dir>

set -eo pipefail

BIN_DIR=$(cd $(dirname $0); pwd)
source $BIN_DIR/utils

puts-step "Setting up buildpack."

BUILD_DIR="${1}"
CACHE_DIR="${2}"
ENV_DIR="${3}"
XDG_CACHE_HOME="${CACHE_DIR}"
cd $BUILD_DIR

echo "BIN_DIR:   ${BIN_DIR}"   | indent
echo "BUILD_DIR: ${BUILD_DIR}" | indent
echo "CACHE_DIR: ${CACHE_DIR}" | indent
echo "ENV_DIR:   ${ENV_DIR}"   | indent
echo "HOME:      ${HOME}"      | indent

# Setting up profile dir
PROFILE_PATH="$BUILD_DIR/.profile.d/conda.sh"
mkdir -p $(dirname $PROFILE_PATH)

unset  GIT_DIR PYTHONHOME PYTHONPATH LD_LIBRARY_PATH LIBRARY_PATH
export BUILD_DIR CACHE_DIR XDG_CACHE_HOME BIN_DIR PROFILE_PATH

source $BIN_DIR/compile_conda
